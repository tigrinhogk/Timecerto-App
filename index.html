<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor de Times de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.3s ease;
            text-align: center;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        .btn-primary:hover {
            background-color: #45a049;
        }
        .btn-primary:disabled {
            background-color: #a5d6a7; /* Lighter green for disabled */
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #007bff; /* Blue */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107; /* Yellow */
            color: #212529; /* Dark text for yellow */
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
         .btn-delete-match, .btn-edit-match, .btn-finalize-match {
            color: white;
            padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        .btn-delete-match { background-color: #ef4444; } /* Red-500 */
        .btn-delete-match:hover { background-color: #dc2626; } /* Red-600 */
        .btn-edit-match { background-color: #f59e0b; } /* Amber-500 */
        .btn-edit-match:hover { background-color: #d97706; } /* Amber-600 */
        .btn-finalize-match { background-color: #10b981; } /* Emerald-500 */
        .btn-finalize-match:hover { background-color: #059669; } /* Emerald-600 */
        .btn-finalize-match:disabled { background-color: #6ee7b7; cursor: not-allowed; } /* Lighter Emerald */


        input, select {
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        input[type="checkbox"] {
            width: auto; 
            margin-right: 0.5rem; 
            transform: scale(1.2); 
        }
        input[type="number"].stat-input {
            width: 50px; /* Largura menor para inputs de estatísticas */
            padding: 0.5rem 0.25rem; /* Ajustado padding */
            text-align: center;
            font-size: 0.875rem; /* Fonte menor para inputs */
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); 
        }
        .error-message {
            color: #ef4444; 
            font-size: 0.875rem; 
            margin-top: 0.25rem;
        }
        .team-box {
            border: 1px solid #e5e7eb; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            min-height: 200px;
        }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0; 
            border-bottom: 1px dashed #e5e7eb;
        }
        .player-item:last-child {
            border-bottom: none;
        }
        .player-info { 
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 1rem;
        }
        .player-details {
            margin-left: 0.5rem; 
        }
        .player-actions button {
            margin-left: 0.5rem; 
        }

        .delete-btn, .edit-btn { 
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            transition: background-color 0.3s ease;
        }
        .delete-btn {
            background-color: #ef4444; 
        }
        .delete-btn:hover {
            background-color: #dc2626; 
        }
        .edit-btn {
            background-color: #f59e0b; 
        }
        .edit-btn:hover {
            background-color: #d97706; 
        }
        .message-box {
            position: fixed;
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            padding: 1rem 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; 
            text-align: center;
            border: 1px solid #e5e7eb;
            max-width: 90%;
        }
        .message-box p {
            margin: 0;
            font-size: 0.9rem;
        }
        .message-box button { 
            display:none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle; 
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .hidden {
            display: none !important;
        }
        .option-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem; 
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .option-card.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        .option-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
        }
        .option-card table th, .option-card table td {
             padding: 0.5rem 0.75rem; 
             font-size: 0.875rem; 
        }
        .color-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .color-option.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
            background-color: #ecfdf5; 
        }
        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        .match-item { 
            background-color: #f9fafb; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            border: 1px solid #e5e7eb; 
            margin-bottom: 1rem; 
        }
        .match-item h4 {
            font-size: 1.125rem; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 0.5rem; 
        }
        .match-item p {
            font-size: 0.875rem; 
            color: #4b5563; 
            margin-bottom: 0.25rem; 
        }
        .match-item .teams-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 0.75rem; 
            margin-top: 0.75rem; 
            margin-bottom: 0.75rem;
        }
        @media (min-width: 768px) { 
            .match-item .teams-grid {
                grid-template-columns: 1fr 1fr; 
            }
        }
        .match-item .team-details table {
            margin-top: 0.5rem;
        }
        .match-item .player-stats-summary {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.25rem;
        }
        .score-input {
            width: 60px;
            text-align: center;
            font-size: 1.25rem; 
            padding: 0.5rem;
        }
        .stats-player-item {
            padding: 0.75rem 0; /* Aumentado padding vertical */
            border-bottom: 1px solid #eee;
        }
        .stats-player-item:last-child {
            border-bottom: none;
        }
        .stats-player-name {
            font-weight: 500; /* medium */
            margin-bottom: 0.5rem; /* Espaço abaixo do nome */
            display: block; /* Para ocupar a linha toda */
        }
        .stats-input-group {
            display: flex;
            flex-wrap: wrap; /* Permite que os inputs quebrem linha se necessário */
            gap: 0.5rem; /* Espaço entre os inputs de estatísticas */
            align-items: center;
        }
        .stats-input-group label {
            font-size: 0.75rem; /* text-xs */
            color: #4b5563; /* text-gray-600 */
            min-width: 20px; /* Para alinhar os inputs */
            text-align: right;
        }

    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Divisor de Times de Futebol</h1>

        <div id="page1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h2 id="playerFormTitle" class="text-2xl font-semibold mb-6 text-gray-700">Adicionar Jogador</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="playerName" class="block text-gray-700 text-sm font-medium mb-2">Nome do Jogador:</label>
                            <input type="text" id="playerName" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-200" placeholder="Ex: Messi">
                            <p id="playerNameError" class="error-message hidden">O nome do jogador é obrigatório.</p>
                        </div>
                        <div>
                            <label for="playerOverall" class="block text-gray-700 text-sm font-medium mb-2">Overall (50-100):</label>
                            <input type="number" id="playerOverall" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-200" min="50" max="100" placeholder="Ex: 95">
                            <p id="playerOverallError" class="error-message hidden">Overall deve ser entre 50 e 100.</p>
                        </div>
                        <div>
                            <label for="playerPosition" class="block text-gray-700 text-sm font-medium mb-2">Posição:</label>
                            <select id="playerPosition" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-200">
                                <option value="">Selecione a Posição</option>
                                <option value="GO">Goleiro (GO)</option>
                                <option value="ZAG">Zagueiro (ZAG)</option>
                                <option value="MEI">Meio-campo (MEI)</option>
                                <option value="ATA">Atacante (ATA)</option>
                            </select>
                            <p id="playerPositionError" class="error-message hidden">A posição do jogador é obrigatória.</p>
                        </div>
                        <button id="addPlayerBtn" class="btn btn-primary w-full">Adicionar Jogador</button>
                        <button id="cancelEditBtn" class="btn btn-danger w-full mt-2 hidden">Cancelar Edição</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Jogadores Adicionados <span id="playerCount">(0/0)</span></h2>
                    <div id="playerList" class="space-y-2 max-h-96 overflow-y-auto"> 
                        <p class="text-gray-500 text-center" id="noPlayersMessage">Nenhum jogador adicionado ainda.</p>
                    </div>
                    <button id="goToDivisionOptionsBtn" class="btn btn-secondary w-full mt-6" disabled>Dividir Times com Selecionados</button>
                </div>
            </div>

            <div id="scheduledMatchesSection" class="card mt-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Partidas Agendadas</h2>
                <div id="scheduledMatchesList" class="space-y-4">
                    <p id="noScheduledMatchesMessage" class="text-gray-500 text-center">Nenhuma partida agendada ainda.</p>
                </div>
            </div>

            <div id="finishedMatchesSection" class="card mt-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Partidas Finalizadas</h2>
                <div id="finishedMatchesList" class="space-y-4">
                    <p id="noFinishedMatchesMessage" class="text-gray-500 text-center">Nenhuma partida finalizada ainda.</p>
                </div>
            </div>
        </div>


        <div id="page2" class="hidden">
            <div class="card mt-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Escolha uma Divisão de Times</h2>
                <div id="divisionOptionsContainer" class="space-y-6"></div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="backToPlayersBtnPage2" class="btn btn-secondary w-full sm:w-auto">Voltar para Jogadores</button>
                    <button id="confirmDivisionBtn" class="btn btn-primary w-full sm:w-auto flex-grow" disabled>Confirmar Divisão</button>
                </div>
            </div>
        </div>

        <div id="page3" class="hidden">
            <div class="card mt-8">
                <h2 id="colorsPageTitle" class="text-2xl font-semibold mb-6 text-gray-700">Escolha as Cores dos Uniformes</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Time A Uniforme:</h3>
                        <div class="flex flex-col gap-4">
                            <label class="color-option" data-team="A" data-color="PRETO">
                                <input type="radio" name="teamAColor" value="PRETO" class="hidden">
                                <span class="color-box bg-black"></span>
                                <span>PRETO</span>
                            </label>
                            <label class="color-option" data-team="A" data-color="COLORIDO">
                                <input type="radio" name="teamAColor" value="COLORIDO" class="hidden">
                                <span class="color-box bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"></span>
                                <span>COLORIDO</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Time B Uniforme:</h3>
                        <div class="flex flex-col gap-4">
                            <label class="color-option" data-team="B" data-color="PRETO">
                                <input type="radio" name="teamBColor" value="PRETO" class="hidden">
                                <span class="color-box bg-black"></span>
                                <span>PRETO</span>
                            </label>
                            <label class="color-option" data-team="B" data-color="COLORIDO">
                                <input type="radio" name="teamBColor" value="COLORIDO" class="hidden">
                                <span class="color-box bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></span>
                                <span>COLORIDO</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="backToDivisionBtnPage3" class="btn btn-secondary w-full sm:w-auto">Voltar para Divisões</button>
                    <button id="confirmColorsBtn" class="btn btn-primary w-full sm:w-auto flex-grow" disabled>Confirmar Cores</button>
                </div>
            </div>
        </div>

        <div id="page4" class="hidden">
            <div class="card mt-8">
                <h2 id="dateTimePageTitle" class="text-2xl font-semibold mb-6 text-gray-700">Escolha o Dia e Horário</h2>
                <div class="mb-6">
                    <label for="gameDate" class="block text-gray-700 text-sm font-medium mb-2">Selecione o Dia:</label>
                    <input type="date" id="gameDate" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-200">
                    <p id="gameDateError" class="error-message hidden">Por favor, selecione uma data.</p>
                </div>
                <h3 class="text-xl font-medium mb-4 text-gray-700">Selecione o Horário:</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="timeOptionsContainer"></div>
                <p id="gameTimeError" class="error-message hidden">Por favor, selecione um horário.</p>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="backToColorsBtnPage4" class="btn btn-secondary w-full sm:w-auto">Voltar para Cores</button>
                    <button id="confirmTimeBtn" class="btn btn-primary w-full sm:w-auto flex-grow" disabled>Confirmar Horário</button>
                </div>
            </div>
        </div>

        <div id="page5" class="hidden">
            <div class="card mt-8 text-center">
                <h2 class="text-3xl font-bold mb-4 text-gray-800">Partida Agendada!</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                    <div class="team-box">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Time A <span class="text-gray-500 text-base">(Overall Total: <span id="finalTeamAOverall">0</span>)</span></h3>
                        <p class="text-lg text-gray-700 mb-2">Uniforme: <span id="finalTeamAColor"></span></p>
                        <table class="w-full text-left table-auto">
                            <thead><tr class="bg-gray-100"><th class="px-4 py-2 rounded-tl-lg">Posição</th><th class="px-4 py-2">Nome</th><th class="px-4 py-2 rounded-tr-lg text-right">Overall</th></tr></thead>
                            <tbody id="finalTeamAList"></tbody>
                        </table>
                    </div>
                    <div class="team-box">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Time B <span class="text-gray-500 text-base">(Overall Total: <span id="finalTeamBOverall">0</span>)</span></h3>
                        <p class="text-lg text-gray-700 mb-2">Uniforme: <span id="finalTeamBColor"></span></p>
                        <table class="w-full text-left table-auto">
                            <thead><tr class="bg-gray-100"><th class="px-4 py-2 rounded-tl-lg">Posição</th><th class="px-4 py-2">Nome</th><th class="px-4 py-2 rounded-tr-lg text-right">Overall</th></tr></thead>
                            <tbody id="finalTeamBList"></tbody>
                        </table>
                    </div>
                </div>
                <p class="text-xl font-bold text-gray-800 mt-8">Dia: <span id="finalGameDate"></span> - Horário: <span id="finalGameTime"></span></p>
                <div class="mt-6 space-y-4">
                    <button onclick="window.resetApp()" class="btn btn-secondary w-full">Voltar à Tela Inicial</button>
                </div>
            </div>
        </div>

        <div id="page6" class="hidden">
            <div class="card mt-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Finalizar Partida e Registrar Placar</h2>
                <div class="mb-6">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Placar Final:</h3>
                    <div class="flex items-center justify-center gap-4">
                        <div>
                            <label for="scoreTeamA" class="block text-center text-lg font-medium text-gray-700 mb-1">Time A</label>
                            <input type="number" id="scoreTeamA" min="0" class="score-input border border-gray-300 rounded-md">
                        </div>
                        <span class="text-2xl font-bold text-gray-500">vs</span>
                        <div>
                            <label for="scoreTeamB" class="block text-center text-lg font-medium text-gray-700 mb-1">Time B</label>
                            <input type="number" id="scoreTeamB" min="0" class="score-input border border-gray-300 rounded-md">
                        </div>
                    </div>
                     <p id="scoreError" class="error-message hidden text-center mt-2">Insira um placar válido.</p>
                </div>

                <div class="mt-8 space-y-6"> 
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3 border-b pb-2">Estatísticas - Time A:</h3>
                        <div id="statsTeamAContainer" class="space-y-4"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3 border-b pb-2">Estatísticas - Time B:</h3>
                        <div id="statsTeamBContainer" class="space-y-4"></div>
                    </div>
                </div>
                <p id="statsError" class="error-message hidden text-center mt-4">Insira estatísticas válidas (números não negativos).</p>

                <div class="mt-10 flex flex-col sm:flex-row gap-4">
                    <button id="cancelFinalizeBtn" class="btn btn-secondary w-full sm:w-auto">Cancelar</button>
                    <button id="saveScoreBtn" class="btn btn-primary w-full sm:w-auto flex-grow">Salvar Placar e Estatísticas</button>
                </div>
            </div>
        </div>


    </div>

    <div id="messageBox" class="message-box">
        <p id="messageBoxText"></p>
    </div>

    <script type="module">
        // Variáveis de estado globais
        let players = []; 
        let scheduledMatches = []; 
        let finishedMatches = []; 
        let divisionOptions = [];
        let selectedDivisionIndex = -1;
        let selectedColors = { teamA: null, teamB: null };
        let selectedDate = null;
        let selectedTime = null;
        let editingPlayerId = null; 
        let editingMatchId = null; 
        let finalizingMatchId = null; 
        let messageTimeout = null; 

        // Referências aos elementos do DOM
        const page1 = document.getElementById('page1');
        const page2 = document.getElementById('page2');
        const page3 = document.getElementById('page3');
        const page4 = document.getElementById('page4');
        const page5 = document.getElementById('page5');
        const page6 = document.getElementById('page6'); 

        const playerFormTitle = document.getElementById('playerFormTitle');
        const playerNameInput = document.getElementById('playerName');
        const playerOverallInput = document.getElementById('playerOverall');
        const playerPositionSelect = document.getElementById('playerPosition');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn'); 
        const playerListDiv = document.getElementById('playerList');
        const playerCountSpan = document.getElementById('playerCount');
        const goToDivisionOptionsBtn = document.getElementById('goToDivisionOptionsBtn');
        const noPlayersMessage = document.getElementById('noPlayersMessage');
        const messageBox = document.getElementById('messageBox');
        const messageBoxText = document.getElementById('messageBoxText');

        const divisionOptionsContainer = document.getElementById('divisionOptionsContainer');
        const confirmDivisionBtn = document.getElementById('confirmDivisionBtn');

        const colorsPageTitle = document.getElementById('colorsPageTitle');
        const teamAColorOptions = document.querySelectorAll('label[data-team="A"]');
        const teamBColorOptions = document.querySelectorAll('label[data-team="B"]');
        const confirmColorsBtn = document.getElementById('confirmColorsBtn');
        
        const dateTimePageTitle = document.getElementById('dateTimePageTitle');
        const gameDateInput = document.getElementById('gameDate');
        const gameDateError = document.getElementById('gameDateError');
        const timeOptionsContainer = document.getElementById('timeOptionsContainer');
        const gameTimeError = document.getElementById('gameTimeError');
        const confirmTimeBtn = document.getElementById('confirmTimeBtn');

        const finalTeamAColorSpan = document.getElementById('finalTeamAColor');
        const finalTeamBColorSpan = document.getElementById('finalTeamBColor');
        const finalGameDateSpan = document.getElementById('finalGameDate');
        const finalGameTimeSpan = document.getElementById('finalGameTime');
        const finalTeamAList = document.getElementById('finalTeamAList');
        const finalTeamBList = document.getElementById('finalTeamBList');
        const finalTeamAOverallSpan = document.getElementById('finalTeamAOverall');
        const finalTeamBOverallSpan = document.getElementById('finalTeamBOverall');

        const scheduledMatchesListDiv = document.getElementById('scheduledMatchesList');
        const noScheduledMatchesMessageP = document.getElementById('noScheduledMatchesMessage');
        const finishedMatchesListDiv = document.getElementById('finishedMatchesList');
        const noFinishedMatchesMessageP = document.getElementById('noFinishedMatchesMessage');

        // Elementos da Página 6 (Finalizar Partida)
        // const finalizeMatchInfoDiv = document.getElementById('finalizeMatchInfo'); // Já declarado acima
        const scoreTeamAInput = document.getElementById('scoreTeamA');
        const scoreTeamBInput = document.getElementById('scoreTeamB');
        const scoreErrorP = document.getElementById('scoreError');
        const statsTeamAContainer = document.getElementById('statsTeamAContainer');
        const statsTeamBContainer = document.getElementById('statsTeamBContainer');
        const statsErrorP = document.getElementById('statsError');
        const cancelFinalizeBtn = document.getElementById('cancelFinalizeBtn');
        const saveScoreBtn = document.getElementById('saveScoreBtn');


        // --- Funções de localStorage com console.log para debug ---
        function savePlayersToLocalStorage() {
            console.log("Salvando jogadores no localStorage:", JSON.stringify(players));
            localStorage.setItem('soccerTeamDividerPlayers', JSON.stringify(players));
        }
        function loadPlayersFromLocalStorage() {
            console.log("Carregando jogadores do localStorage...");
            const stored = localStorage.getItem('soccerTeamDividerPlayers');
            if (stored) {
                players = JSON.parse(stored).map(player => ({...player, isPlayingThisWeek: player.isPlayingThisWeek === undefined ? true : player.isPlayingThisWeek }));
                console.log("Jogadores carregados:", players);
            } else {
                console.log("Nenhum jogador encontrado no localStorage.");
            }
        }
        function saveScheduledMatchesToLocalStorage() {
            console.log("Salvando partidas agendadas no localStorage:", JSON.stringify(scheduledMatches));
            localStorage.setItem('soccerTeamDividerMatches', JSON.stringify(scheduledMatches));
        }
        function loadScheduledMatchesFromLocalStorage() {
            console.log("Carregando partidas agendadas do localStorage...");
            const stored = localStorage.getItem('soccerTeamDividerMatches');
            if (stored) {
                scheduledMatches = JSON.parse(stored);
                console.log("Partidas agendadas carregadas:", scheduledMatches);
            } else {
                console.log("Nenhuma partida agendada encontrada no localStorage.");
            }
        }
        function saveFinishedMatchesToLocalStorage() {
            console.log("Salvando partidas finalizadas no localStorage:", JSON.stringify(finishedMatches));
            localStorage.setItem('soccerTeamDividerFinishedMatches', JSON.stringify(finishedMatches));
        }
        function loadFinishedMatchesFromLocalStorage() {
            console.log("Carregando partidas finalizadas do localStorage...");
            const stored = localStorage.getItem('soccerTeamDividerFinishedMatches');
            if (stored) {
                finishedMatches = JSON.parse(stored);
                console.log("Partidas finalizadas carregadas:", finishedMatches);
            } else {
                console.log("Nenhuma partida finalizada encontrada no localStorage.");
            }
        }

        window.showPage = function(pageToShow) {
            [page1, page2, page3, page4, page5, page6].forEach(page => {
                page.classList.toggle('hidden', page !== pageToShow);
            });
        }

        function resetPlayerForm() {
            playerNameInput.value = ''; playerOverallInput.value = ''; playerPositionSelect.value = '';
            editingPlayerId = null; 
            playerFormTitle.textContent = 'Adicionar Jogador';
            addPlayerBtn.textContent = 'Adicionar Jogador';
            cancelEditBtn.classList.add('hidden'); 
            playerNameInput.focus();
            ['playerNameError', 'playerOverallError', 'playerPositionError'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        window.resetApp = function(goToPage1 = true) { 
            divisionOptions = []; selectedDivisionIndex = -1;
            selectedColors = { teamA: null, teamB: null };
            selectedDate = null; selectedTime = null;
            editingMatchId = null; finalizingMatchId = null; 

            players.forEach(player => player.isPlayingThisWeek = false); 
            savePlayersToLocalStorage(); 

            resetPlayerForm(); 
            gameDateInput.value = '';
            renderPlayerList(); 
            renderScheduledMatches(); 
            renderFinishedMatches();

            [confirmDivisionBtn, confirmColorsBtn, confirmTimeBtn].forEach(btn => btn.disabled = true);
            teamAColorOptions.forEach(label => label.classList.remove('selected'));
            teamBColorOptions.forEach(label => label.classList.remove('selected'));
            document.querySelectorAll('input[name="teamAColor"], input[name="teamBColor"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('#timeOptionsContainer .color-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('input[name="gameTime"]').forEach(radio => radio.checked = false);
            
            if (goToPage1) window.showPage(page1); 
        }

        function getPositionIcon(position) {
            const icons = {'GO': '🧤', 'ZAG': '🛡️', 'MEI': '⭐', 'ATA': '👟'};
            return icons[position] || '';
        }

        function showMessageBox(message, type = 'success') {
            messageBoxText.textContent = message;
            messageBox.className = 'message-box'; 

            const classesToAdd = [];
            if (type === 'success') classesToAdd.push('border-green-500', 'text-green-700', 'bg-green-50');
            else if (type === 'error') classesToAdd.push('border-red-500', 'text-red-700', 'bg-red-50');
            
            classesToAdd.forEach(cls => { if (cls && cls.trim() !== '') messageBox.classList.add(cls); });

            messageBox.style.display = 'block';
            if (messageTimeout) clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
        }

        function validatePlayerInputs() {
            let isValid = true;
            ['playerNameError', 'playerOverallError', 'playerPositionError'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (playerNameInput.value.trim() === '') { document.getElementById('playerNameError').classList.remove('hidden'); isValid = false; }
            const overall = parseInt(playerOverallInput.value);
            if (isNaN(overall) || overall < 50 || overall > 100) { document.getElementById('playerOverallError').classList.remove('hidden'); isValid = false; }
            if (playerPositionSelect.value === '') { document.getElementById('playerPositionError').classList.remove('hidden'); isValid = false; }
            return isValid;
        }

        addPlayerBtn.addEventListener('click', () => {
            try { 
                if (!validatePlayerInputs()) return;
                const name = playerNameInput.value.trim(), overall = parseInt(playerOverallInput.value), position = playerPositionSelect.value;
                if (editingPlayerId !== null) {
                    const index = players.findIndex(p => p.id === editingPlayerId);
                    if (index > -1) { Object.assign(players[index], {name, overall, position}); showMessageBox('Jogador atualizado!'); }
                } else {
                    players.push({ id: Date.now(), name, overall, position, isPlayingThisWeek: true }); showMessageBox('Jogador adicionado!');
                }
                savePlayersToLocalStorage(); renderPlayerList(); resetPlayerForm(); 
            } catch (error) { console.error("Erro em addPlayerBtn:", error); showMessageBox(`Erro: ${error.message}`, "error"); }
        });

        cancelEditBtn.addEventListener('click', () => resetPlayerForm());
        
        window.editPlayer = function(id) {
            try {
                const p = players.find(p => p.id === id);
                if (p) {
                    editingPlayerId = id; playerNameInput.value = p.name; playerOverallInput.value = p.overall; playerPositionSelect.value = p.position;
                    playerFormTitle.textContent = `Editar Jogador: ${p.name}`; addPlayerBtn.textContent = 'Salvar Alterações';
                    cancelEditBtn.classList.remove('hidden'); playerNameInput.focus();
                    playerFormTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (e) { console.error("Edit Player Error:", e); showMessageBox("Erro ao editar jogador.", "error"); }
        }

        window.removePlayer = function(id) { 
            try {
                players = players.filter(p => p.id !== id);
                savePlayersToLocalStorage(); renderPlayerList();
                if (editingPlayerId === id) resetPlayerForm();
            } catch (e) { console.error("Remove Player Error:", e); showMessageBox("Erro ao remover jogador.", "error"); }
        }
        
        window.togglePlayerSelection = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.isPlayingThisWeek = !player.isPlayingThisWeek;
                savePlayersToLocalStorage();
                renderPlayerList(); 
            }
        }

        function renderPlayerList() {
            playerListDiv.innerHTML = ''; 
            const selectedPlayersCount = players.filter(p => p.isPlayingThisWeek).length;
            playerCountSpan.textContent = `(${selectedPlayersCount}/${players.length})`;
            noPlayersMessage.classList.toggle('hidden', players.length > 0);

            if (players.length > 0) {
                const positionOrder = { 'GO': 1, 'ZAG': 2, 'MEI': 3, 'ATA': 4 };
                const sortedPlayers = [...players].sort((a, b) => {
                    const posAVal = positionOrder[a.position] || 5;
                    const posBVal = positionOrder[b.position] || 5;
                    if (posAVal !== posBVal) return posAVal - posBVal;
                    return a.name.localeCompare(b.name);
                });
                
                sortedPlayers.forEach(p => {
                    const div = document.createElement('div'); 
                    div.className = 'player-item bg-gray-50 p-3 rounded-lg';
                    div.innerHTML = `<div class="player-info"><input type="checkbox" id="player-select-${p.id}" onchange="window.togglePlayerSelection(${p.id})" ${p.isPlayingThisWeek ? 'checked' : ''} class="form-checkbox h-5 w-5 text-green-600"><label for="player-select-${p.id}" class="player-details cursor-pointer ml-2"><span class="font-medium text-gray-800">${getPositionIcon(p.position)} ${p.name}</span><span class="text-sm text-gray-600 ml-2">(OVR: ${p.overall}, Pos: ${p.position})</span></label></div><div class="player-actions flex-shrink-0"><button class="edit-btn" onclick="window.editPlayer(${p.id})">Editar</button><button class="delete-btn" onclick="window.removePlayer(${p.id})">Remover</button></div>`;
                    playerListDiv.appendChild(div);
                });
            }
            goToDivisionOptionsBtn.disabled = selectedPlayersCount < 2;
        }

        function sortPlayersForDisplay(arr) { 
            const order = {'GO':1,'ZAG':2,'MEI':3,'ATA':4};
            return [...arr].sort((a,b) => (order[a.position]||99)-(order[b.position]||99) || b.overall-a.overall);
        }

        function renderSingleDivisionOption(division, index, container) {
            const card = document.createElement('div'); card.className = 'option-card'; 
            card.innerHTML = `<input type="radio" name="divisionOption" id="option${index}" value="${index}" class="hidden"><label for="option${index}" class="block cursor-pointer"><h3 class="text-xl font-semibold mb-3 text-gray-700">Opção ${index + 1}</h3><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 text-base"><span class="font-medium mb-1 sm:mb-0">Time A (OVR: ${division.teamA.reduce((s,p)=>s+p.overall,0)})</span><span class="font-medium">Time B (OVR: ${division.teamB.reduce((s,p)=>s+p.overall,0)})</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="font-semibold text-gray-600 mb-2">Time A</h4><table class="w-full text-left"><thead><tr class="bg-gray-50"><th class="px-3 py-2">Pos</th><th class="px-3 py-2">Nome</th><th class="px-3 py-2 text-right">OVR</th></tr></thead><tbody>${sortPlayersForDisplay(division.teamA).map(p=>`<tr><td class="px-3 py-2">${p.position}</td><td class="px-3 py-2 truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="px-3 py-2 text-right">${p.overall}</td></tr>`).join('')}${division.teamA.length===0?'<tr><td colspan="3" class="px-3 py-2 text-center text-gray-400">Vazio</td></tr>':''}</tbody></table></div><div><h4 class="font-semibold text-gray-600 mb-2">Time B</h4><table class="w-full text-left"><thead><tr class="bg-gray-50"><th class="px-3 py-2">Pos</th><th class="px-3 py-2">Nome</th><th class="px-3 py-2 text-right">OVR</th></tr></thead><tbody>${sortPlayersForDisplay(division.teamB).map(p=>`<tr><td class="px-3 py-2">${p.position}</td><td class="px-3 py-2 truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="px-3 py-2 text-right">${p.overall}</td></tr>`).join('')}${division.teamB.length===0?'<tr><td colspan="3" class="px-3 py-2 text-center text-gray-400">Vazio</td></tr>':''}</tbody></table></div></div></label>`;
            container.appendChild(card);
            card.querySelector('label').addEventListener('click',()=>{document.querySelectorAll('#divisionOptionsContainer .option-card').forEach(c=>c.classList.remove('selected'));card.classList.add('selected');selectedDivisionIndex=index;confirmDivisionBtn.disabled=false;});
        }
        
        function shuffleArray(array) {
            const shuffledArray = [...array]; 
            for (let i = shuffledArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledArray[i], shuffledArray[j]] = [shuffledArray[j], shuffledArray[i]]; 
            }
            return shuffledArray;
        }

        // LÓGICA DE DIVISÃO (v6.0)
        function generateSingleDivision(playersToDivide, seed = 0) {
            const teams = { teamA: [], teamB: [] };
            let availablePlayers = JSON.parse(JSON.stringify(playersToDivide));

            const assignPlayer = (player, teamKey) => {
                if (!player) return;
                teams[teamKey].push(player);
                availablePlayers = availablePlayers.filter(p => p.id !== player.id);
            };

            const pickAndRemove = (list, count = 1) => { 
                if (!list || list.length === 0) return count === 1 ? null : [];
                list.sort((a, b) => b.overall - a.overall);
                return count === 1 ? list.shift() : list.splice(0, count);
            };
            
            const getTeamOverall = (teamKey) => teams[teamKey].reduce((sum, p) => sum + p.overall, 0);

            let goalkeepers = availablePlayers.filter(p => p.position === 'GO');
            let defenders = availablePlayers.filter(p => p.position === 'ZAG');
            let midfielders = availablePlayers.filter(p => p.position === 'MEI');
            let attackers = availablePlayers.filter(p => p.position === 'ATA');

            // 1. Goleiros
            if (goalkeepers.length === 1) {
                assignPlayer(pickAndRemove(goalkeepers), (seed === 2) ? 'teamB' : 'teamA');
            } else if (goalkeepers.length >= 2) {
                assignPlayer(pickAndRemove(goalkeepers), 'teamA');
                assignPlayer(pickAndRemove(goalkeepers), 'teamB');
            }

            // 2. Tentativa de 1 MEI e 1 ATA por time
            let firstPickMid = (seed === 1) ? 'teamA' : (seed === 2 ? 'teamB' : 'teamA');
            let secondPickMid = firstPickMid === 'teamA' ? 'teamB' : 'teamA';
            let firstPickAtk = (seed === 1 || seed === 3) ? 'teamA' : 'teamB'; 
            let secondPickAtk = firstPickAtk === 'teamA' ? 'teamB' : 'teamA';

            if (midfielders.length > 0) assignPlayer(pickAndRemove(midfielders), firstPickMid);
            if (midfielders.length > 0) assignPlayer(pickAndRemove(midfielders), secondPickMid);
            if (attackers.length > 0) assignPlayer(pickAndRemove(attackers), firstPickAtk);
            if (attackers.length > 0) assignPlayer(pickAndRemove(attackers), secondPickAtk);
            
            let remainingPlayers = [
                ...goalkeepers, ...defenders, ...midfielders, ...attackers,
                ...availablePlayers.filter(p => !['GO', 'ZAG', 'MEI', 'ATA'].includes(p.position)) 
            ].filter((p, i, self) => p && self.findIndex(s => s && s.id === p.id) === i); 

            if (seed === 1) { 
                remainingPlayers.sort((a, b) => b.overall - a.overall);
            } else if (seed === 2) { 
                remainingPlayers.sort((a, b) => b.overall - a.overall); 
            } else { 
                remainingPlayers = shuffleArray(remainingPlayers);
                remainingPlayers.sort((a,b) => b.overall - a.overall); 
            }
            
            while (remainingPlayers.length > 0) {
                const playerToAssign = remainingPlayers.shift();
                if (!playerToAssign) continue;
                const overallA = getTeamOverall('teamA');
                const overallB = getTeamOverall('teamB');
                const countA = teams.teamA.length;
                const countB = teams.teamB.length;
                let assignToA = false;

                if (seed === 1) { 
                    if (countA <= countB) assignToA = true;
                    else if (overallA <= overallB + 3) assignToA = true; 
                    else assignToA = false;
                } else if (seed === 2) { 
                    if (countB <= countA) assignToA = false;
                    else if (overallB <= overallA + 3) assignToA = false; 
                    else assignToA = true;
                } else { 
                    if (countA < countB) assignToA = true;
                    else if (countB < countA) assignToA = false;
                    else if (overallA <= overallB) assignToA = true;
                    else assignToA = false;
                }
                assignPlayer(playerToAssign, assignToA ? 'teamA' : 'teamB');
            }
            return teams;
        }

        goToDivisionOptionsBtn.addEventListener('click',()=>{
            const selectedPlayersForGame = players.filter(p => p.isPlayingThisWeek);
            if(selectedPlayersForGame.length < 2){
                showMessageBox('Selecione pelo menos 2 jogadores para dividir os times.', 'error');
                return;
            }
            divisionOptions=[];divisionOptionsContainer.innerHTML='';selectedDivisionIndex=-1;confirmDivisionBtn.disabled=true;
            [1,2,3].forEach(s=>divisionOptions.push(generateSingleDivision(selectedPlayersForGame,s))); 
            divisionOptions.forEach((d,i)=>renderSingleDivisionOption(d,i,divisionOptionsContainer));
            window.showPage(page2);
        });

        confirmDivisionBtn.addEventListener('click',()=>{if(selectedDivisionIndex===-1){showMessageBox('Selecione uma divisão.', 'error');return;}window.showPage(page3); colorsPageTitle.textContent = "Escolha as Cores dos Uniformes";});
        
        function prefillColorsForEdit(match) {
            selectedColors.teamA = match.teamA.color;
            selectedColors.teamB = match.teamB.color;
            teamAColorOptions.forEach(opt => {
                const isSelected = opt.dataset.color === selectedColors.teamA;
                opt.classList.toggle('selected', isSelected);
                if(opt.querySelector('input')) opt.querySelector('input').checked = isSelected;
            });
            teamBColorOptions.forEach(opt => {
                const isSelected = opt.dataset.color === selectedColors.teamB;
                opt.classList.toggle('selected', isSelected);
                if(opt.querySelector('input')) opt.querySelector('input').checked = isSelected;
            });
            confirmColorsBtn.disabled = false;
        }

        function handleColorSelection(clickedTeamChar, clickedColor) {
            const otherTeamChar = clickedTeamChar === 'A' ? 'B' : 'A';
            const otherColorRequired = clickedColor === 'PRETO' ? 'COLORIDO' : 'PRETO';
            if (clickedTeamChar === 'A') { selectedColors.teamA = clickedColor; selectedColors.teamB = otherColorRequired; } 
            else { selectedColors.teamB = clickedColor; selectedColors.teamA = otherColorRequired; }
            teamAColorOptions.forEach(opt=>{const isSel=opt.dataset.color===selectedColors.teamA;opt.classList.toggle('selected',isSel);if(opt.querySelector('input'))opt.querySelector('input').checked=isSel;});
            teamBColorOptions.forEach(opt=>{const isSel=opt.dataset.color===selectedColors.teamB;opt.classList.toggle('selected',isSel);if(opt.querySelector('input'))opt.querySelector('input').checked=isSel;});
            confirmColorsBtn.disabled = !(selectedColors.teamA && selectedColors.teamB);
        }
        teamAColorOptions.forEach(l=>l.addEventListener('click',()=>handleColorSelection('A',l.dataset.color)));
        teamBColorOptions.forEach(l=>l.addEventListener('click',()=>handleColorSelection('B',l.dataset.color)));

        confirmColorsBtn.addEventListener('click',()=>{
            if(!selectedColors.teamA||!selectedColors.teamB){showMessageBox('Selecione as cores.', 'error');return;}
            if(selectedColors.teamA===selectedColors.teamB){showMessageBox('Cores devem ser diferentes.', 'error');return;}
            
            if (editingMatchId) { 
                const match = scheduledMatches.find(m => m.id === editingMatchId);
                if (match) {
                    dateTimePageTitle.textContent = "Editar Dia e Horário da Partida";
                    if (match.date) gameDateInput.value = match.date;
                    if (match.time) selectedTime = match.time; 
                }
            } else {
                 dateTimePageTitle.textContent = "Escolha o Dia e Horário";
                 gameDateInput.value = ''; 
                 selectedTime = null;
            }
            renderTimeOptions(selectedTime); 
            window.showPage(page4);
        });
        
        function prefillDateTimeForEdit(match) {
            if (match.date) gameDateInput.value = match.date;
            selectedTime = match.time; 
            renderTimeOptions(selectedTime); 
            checkTimeAndDateSelection();
        }

        gameDateInput.addEventListener('change',()=>{selectedDate=gameDateInput.value;gameDateError.classList.add('hidden');checkTimeAndDateSelection();});
        
        function renderTimeOptions(preSelectedTime = null) {
            timeOptionsContainer.innerHTML = ''; 
            const startH = 18, endH = 22, intervalMin = 30;
            for (let h = startH; h <= endH; h++) {
                for (let m = 0; m < 60; m += intervalMin) {
                    if (h === endH && m > 30) break; 
                    const formattedTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    const label = document.createElement('label'); 
                    label.className = 'color-option text-center'; 
                    if (formattedTime === preSelectedTime) { 
                        label.classList.add('selected');
                        selectedTime = formattedTime; 
                    }
                    label.setAttribute('for',`time-${formattedTime.replace(':','-')}`);
                    label.innerHTML = `<input type="radio" name="gameTime" value="${formattedTime}" id="time-${formattedTime.replace(':','-')}" class="hidden" ${formattedTime === preSelectedTime ? 'checked' : ''}> ${formattedTime}`;
                    timeOptionsContainer.appendChild(label);
                    label.addEventListener('click',()=>{document.querySelectorAll('#timeOptionsContainer .color-option').forEach(o=>o.classList.remove('selected'));label.classList.add('selected');selectedTime=formattedTime;document.getElementById(`time-${formattedTime.replace(':','-')}`).checked=true;gameTimeError.classList.add('hidden');checkTimeAndDateSelection();});
                }
            }
             checkTimeAndDateSelection(); 
        }

        function checkTimeAndDateSelection(){confirmTimeBtn.disabled=!(selectedDate&&selectedTime);}

        confirmTimeBtn.addEventListener('click',()=>{
            let isValid=true;
            if(!selectedDate){gameDateError.classList.remove('hidden');isValid=false;}
            if(!selectedTime){gameTimeError.classList.remove('hidden');isValid=false;}
            if(!isValid){showMessageBox('Selecione dia e horário.', 'error');return;}

            if (editingMatchId) { 
                const matchIndex = scheduledMatches.findIndex(m => m.id === editingMatchId);
                if (matchIndex > -1) {
                    scheduledMatches[matchIndex].teamA.color = selectedColors.teamA;
                    scheduledMatches[matchIndex].teamB.color = selectedColors.teamB;
                    scheduledMatches[matchIndex].date = selectedDate;
                    scheduledMatches[matchIndex].time = selectedTime;
                    saveScheduledMatchesToLocalStorage();
                    renderScheduledMatches();
                    showMessageBox('Partida atualizada com sucesso!', 'success');
                    editingMatchId = null; 
                    window.resetApp(true); 
                }
            } else { 
                const playersForThisGame = players.filter(p => p.isPlayingThisWeek); 
                const finalDivision = divisionOptions[selectedDivisionIndex]; 
                const matchId = Date.now(); 
                const newMatch = {id:matchId,teamA:{players:JSON.parse(JSON.stringify(finalDivision.teamA)),overall:finalDivision.teamA.reduce((s,p)=>s+p.overall,0),color:selectedColors.teamA},teamB:{players:JSON.parse(JSON.stringify(finalDivision.teamB)),overall:finalDivision.teamB.reduce((s,p)=>s+p.overall,0),color:selectedColors.teamB},date:selectedDate,time:selectedTime};
                scheduledMatches.push(newMatch);
                saveScheduledMatchesToLocalStorage();
                renderScheduledMatches(); 
                finalTeamAColorSpan.textContent=selectedColors.teamA;finalTeamBColorSpan.textContent=selectedColors.teamB;
                const[y,m,d]=selectedDate.split('-');finalGameDateSpan.textContent=`${d}/${m}/${y}`;finalGameTimeSpan.textContent=selectedTime;
                renderFinalTeams(finalDivision.teamA,finalDivision.teamB); 
                window.showPage(page5);
            }
        });

        function renderFinalTeams(teamA,teamB){const sA=sortPlayersForDisplay(teamA);const sB=sortPlayersForDisplay(teamB);finalTeamAList.innerHTML=sA.length===0?'<tr><td colspan="3" class="text-gray-500 text-center py-4">Vazio Time A</td></tr>':sA.map(p=>`<tr class="border-b border-gray-200 last:border-b-0"><td class="px-4 py-2">${p.position}</td><td class="px-4 py-2 truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="px-4 py-2 text-right">${p.overall}</td></tr>`).join('');finalTeamBList.innerHTML=sB.length===0?'<tr><td colspan="3" class="text-gray-500 text-center py-4">Vazio Time B</td></tr>':sB.map(p=>`<tr class="border-b border-gray-200 last:border-b-0"><td class="px-4 py-2">${p.position}</td><td class="px-4 py-2 truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="px-4 py-2 text-right">${p.overall}</td></tr>`).join('');finalTeamAOverallSpan.textContent=teamA.reduce((s,p)=>s+p.overall,0);finalTeamBOverallSpan.textContent=teamB.reduce((s,p)=>s+p.overall,0);}
        
        function renderMatchItem(match, targetListDiv, isFinished = false) {
            const matchDiv = document.createElement('div');
            matchDiv.className = 'match-item'; 
            const [year, month, day] = match.date.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const matchDateTime = new Date(`${match.date}T${match.time}:00`);
            const oneHourAfterMatch = new Date(matchDateTime.getTime() + 60 * 60 * 1000);
            const now = new Date();
            const canFinalize = now >= oneHourAfterMatch;

            let buttonsHtml = '';
            if (!isFinished) {
                buttonsHtml = `
                    <button class="btn-edit-match" onclick="window.editScheduledMatch(${match.id})">Editar</button>
                    <button class="btn-finalize-match" onclick="window.promptFinalizeMatch(${match.id})" ${canFinalize ? '' : 'disabled'}>Finalizar</button>
                    <button class="btn-delete-match" onclick="window.deleteScheduledMatch(${match.id}, false)">Excluir</button>
                `;
            } else {
                 buttonsHtml = `<button class="btn-delete-match" onclick="window.deleteScheduledMatch(${match.id}, true)">Excluir Histórico</button>`;
            }
            
            let scoreHtml = '';
            let statsSummaryHtml = ''; 

            if (isFinished) {
                scoreHtml = `<p class="font-bold text-lg mt-2">Placar Final: Time A ${match.scoreA} x ${match.scoreB} Time B</p>`;
                
                const buildPlayerStatsSummary = (playersWithStats) => {
                    if (!playersWithStats || playersWithStats.length === 0) return '<tr><td colspan="2" class="text-center text-gray-400">Sem estatísticas</td></tr>';
                    return playersWithStats.map(p => {
                        if (!p.matchStats) return `<tr><td>${getPositionIcon(p.position)} ${p.name}</td><td>(sem stats)</td></tr>`; 
                        return `<tr>
                                    <td class="truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td>
                                    <td class="player-stats-summary">
                                        G:${p.matchStats.gols || 0}, A:${p.matchStats.assistencias || 0}, D:${p.matchStats.defesas || 0}, GS:${p.matchStats.golsSofridos || 0}, GC:${p.matchStats.golsContra || 0}
                                    </td>
                                </tr>`;
                    }).join('');
                };
                statsSummaryHtml = `
                    <div class="teams-grid">
                        <div class="team-details">
                            <h5 class="font-semibold mt-2">Time A - Estatísticas:</h5>
                            <table class="w-full text-xs"><thead><tr><th>Jogador</th><th>Stats (G/A/D/GS/GC)</th></tr></thead>
                                <tbody>${buildPlayerStatsSummary(match.teamA.players)}</tbody>
                            </table>
                        </div>
                        <div class="team-details">
                            <h5 class="font-semibold mt-2">Time B - Estatísticas:</h5>
                            <table class="w-full text-xs"><thead><tr><th>Jogador</th><th>Stats (G/A/D/GS/GC)</th></tr></thead>
                                <tbody>${buildPlayerStatsSummary(match.teamB.players)}</tbody>
                            </table>
                        </div>
                    </div>`;
            }


            matchDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4>Partida em ${formattedDate} às ${match.time}</h4>
                        <p>Time A (Cor: ${match.teamA.color}, Overall: ${match.teamA.overall}) vs Time B (Cor: ${match.teamB.color}, Overall: ${match.teamB.overall})</p>
                        ${scoreHtml}
                    </div>
                    <div class="flex-shrink-0">${buttonsHtml}</div>
                </div>
                ${isFinished ? statsSummaryHtml : ` 
                <div class="teams-grid">
                    <div class="team-details">
                        <h5 class="font-semibold mt-2">Time A:</h5>
                        <table class="w-full text-xs"><thead><tr><th>Pos</th><th>Nome</th><th class="text-right">OVR</th></tr></thead><tbody>${match.teamA.players.length>0?sortPlayersForDisplay(match.teamA.players).map(p=>`<tr><td>${p.position}</td><td class="truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="text-right">${p.overall}</td></tr>`).join(''):'<tr><td colspan="3" class="text-center text-gray-400">Vazio</td></tr>'}</tbody></table>
                    </div>
                    <div class="team-details">
                        <h5 class="font-semibold mt-2">Time B:</h5>
                        <table class="w-full text-xs"><thead><tr><th>Pos</th><th>Nome</th><th class="text-right">OVR</th></tr></thead><tbody>${match.teamB.players.length>0?sortPlayersForDisplay(match.teamB.players).map(p=>`<tr><td>${p.position}</td><td class="truncate" title="${p.name}">${getPositionIcon(p.position)} ${p.name}</td><td class="text-right">${p.overall}</td></tr>`).join(''):'<tr><td colspan="3" class="text-center text-gray-400">Vazio</td></tr>'}</tbody></table>
                    </div>
                </div>`}
            `;
            targetListDiv.appendChild(matchDiv);
        }

        function renderScheduledMatches() {
            try { 
                scheduledMatchesListDiv.innerHTML = ''; 
                noScheduledMatchesMessageP.classList.toggle('hidden', scheduledMatches.length > 0);
                if (scheduledMatches.length > 0) {
                    [...scheduledMatches].sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).forEach(m=>renderMatchItem(m, scheduledMatchesListDiv, false));
                }
                setTimeout(renderScheduledMatches, 60000); 
            } catch (error) {
                console.error("Erro em renderScheduledMatches:", error);
            }
        }
        function renderFinishedMatches() {
            try { 
                finishedMatchesListDiv.innerHTML = '';
                noFinishedMatchesMessageP.classList.toggle('hidden', finishedMatches.length > 0);
                if (finishedMatches.length > 0) {
                     [...finishedMatches].sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).forEach(m=>renderMatchItem(m, finishedMatchesListDiv, true));
                }
            } catch (error) {
                console.error("Erro em renderFinishedMatches:", error);
            }
        }
        
        window.deleteScheduledMatch = function(matchId, isFromFinishedList) {
            try {
                if (isFromFinishedList) {
                    finishedMatches = finishedMatches.filter(match => match.id !== matchId);
                    saveFinishedMatchesToLocalStorage();
                    renderFinishedMatches();
                } else {
                    scheduledMatches = scheduledMatches.filter(match => match.id !== matchId);
                    saveScheduledMatchesToLocalStorage();
                    renderScheduledMatches();
                }
                showMessageBox('Partida excluída.', 'success');
            } catch (error) {
                console.error("Erro em deleteScheduledMatch:", error);
                showMessageBox(`Erro ao excluir partida: ${error.message}`, "error");
            }
        }

        window.editScheduledMatch = function(matchId) {
            try {
                const matchToEdit = scheduledMatches.find(m => m.id === matchId);
                if (matchToEdit) {
                    editingMatchId = matchId; 
                    selectedColors.teamA = matchToEdit.teamA.color;
                    selectedColors.teamB = matchToEdit.teamB.color;
                    selectedDate = matchToEdit.date; 
                    selectedTime = matchToEdit.time; 
                    
                    colorsPageTitle.textContent = "Editar Cores da Partida";
                    prefillColorsForEdit(matchToEdit); 
                    window.showPage(page3);
                }
            } catch (error) {
                console.error("Erro em editScheduledMatch:", error);
                showMessageBox(`Erro ao tentar editar partida: ${error.message}`, "error");
            }
        }

        window.promptFinalizeMatch = function(matchId) {
            try {
                finalizingMatchId = matchId;
                const match = scheduledMatches.find(m => m.id === matchId);
                if (match) {
                    statsTeamAContainer.innerHTML = ''; 
                    statsTeamBContainer.innerHTML = '';
                    scoreTeamAInput.value = ''; scoreTeamBInput.value = '';
                    scoreErrorP.classList.add('hidden'); statsErrorP.classList.add('hidden');

                    const createStatInputRow = (player) => {
                        const playerRow = document.createElement('div');
                        playerRow.className = 'stats-player-item py-2';
                        playerRow.innerHTML = `
                            <div>
                                <span class="stats-player-name">${getPositionIcon(player.position)} ${player.name} (OVR: ${player.overall})</span>
                                <div class="stats-input-group mt-1">
                                    <label for="stat-gols-${player.id}" class="text-xs">G:</label>
                                    <input type="number" id="stat-gols-${player.id}" data-player-id="${player.id}" data-stat="gols" value="0" min="0" class="stat-input">
                                    <label for="stat-assistencias-${player.id}" class="text-xs ml-2">A:</label>
                                    <input type="number" id="stat-assistencias-${player.id}" data-player-id="${player.id}" data-stat="assistencias" value="0" min="0" class="stat-input">
                                    <label for="stat-defesas-${player.id}" class="text-xs ml-2">D:</label>
                                    <input type="number" id="stat-defesas-${player.id}" data-player-id="${player.id}" data-stat="defesas" value="0" min="0" class="stat-input">
                                    <label for="stat-golsSofridos-${player.id}" class="text-xs ml-2">GS:</label>
                                    <input type="number" id="stat-golsSofridos-${player.id}" data-player-id="${player.id}" data-stat="golsSofridos" value="0" min="0" class="stat-input">
                                    <label for="stat-golsContra-${player.id}" class="text-xs ml-2">GC:</label> <input type="number" id="stat-golsContra-${player.id}" data-player-id="${player.id}" data-stat="golsContra" value="0" min="0" class="stat-input">
                                </div>
                            </div>
                        `;
                        return playerRow;
                    };

                    match.teamA.players.forEach(player => statsTeamAContainer.appendChild(createStatInputRow(player)));
                    match.teamB.players.forEach(player => statsTeamBContainer.appendChild(createStatInputRow(player)));
                    window.showPage(page6);
                }
            } catch (error) {
                console.error("Erro em promptFinalizeMatch:", error);
                showMessageBox(`Erro ao preparar finalização: ${error.message}`, "error");
            }
        }

        cancelFinalizeBtn.addEventListener('click', () => {
            finalizingMatchId = null;
            window.showPage(page1);
        });
        
        // LÓGICA DE PROGRESSÃO DE OVERALL ATUALIZADA (v6.3)
        function calculateOverallChange(player, stats, matchResult) { 
            let overallChange = 0;
            const currentOverall = player.overall;

            // Gols Marcados
            if (stats.gols > 0) {
                if (player.position === 'ATA') overallChange += stats.gols * 0.25;
                else if (player.position === 'MEI') overallChange += stats.gols * 0.5;
                else if (player.position === 'ZAG') overallChange += stats.gols * 0.5; 
                else if (player.position === 'GO') overallChange += stats.gols * 0.75;
            }
            // Assistências
            if (stats.assistencias > 0) {
                if (player.position === 'ATA') overallChange += stats.assistencias * 0.5; 
                else if (player.position === 'MEI') overallChange += stats.assistencias * 0.25;
                else if (player.position === 'ZAG') overallChange += stats.assistencias * 0.5;
                else if (player.position === 'GO') overallChange += stats.assistencias * 0.5; 
            }
            // Defesas
            if (stats.defesas > 0) {
                if (player.position === 'GO') overallChange += stats.defesas * 0.1;
                else overallChange += stats.defesas * 0.5; 
            }
            // Gols Sofridos
            if (stats.golsSofridos > 0) {
                if (player.position === 'GO') overallChange -= stats.golsSofridos * 0.3; 
                else overallChange -= stats.golsSofridos * 0.25; 
            }
            // Gols Contra
            if (stats.golsContra > 0) {
                overallChange -= stats.golsContra * 0.75;
            }

            // Bônus/Penalidade por resultado
            if (matchResult === 'win') overallChange += 0.25; 
            else if (matchResult === 'loss') overallChange -= 0.5;

            let newOverallCalculated = currentOverall + overallChange;
            let newOverall = Math.round(newOverallCalculated);

            if (newOverall > 100) newOverall = 100;
            if (newOverall < 50) newOverall = 50;
            
            return newOverall - currentOverall; 
        }


        saveScoreBtn.addEventListener('click', () => {
            try {
                const finalScoreA = parseInt(scoreTeamAInput.value); 
                const finalScoreB = parseInt(scoreTeamBInput.value);

                if (isNaN(finalScoreA) || finalScoreA < 0 || isNaN(finalScoreB) || finalScoreB < 0) {
                    scoreErrorP.classList.remove('hidden');
                    return;
                }
                scoreErrorP.classList.add('hidden');
                statsErrorP.classList.add('hidden'); 

                const matchIndex = scheduledMatches.findIndex(m => m.id === finalizingMatchId);
                if (matchIndex > -1) {
                    const matchToFinalize = scheduledMatches[matchIndex];
                    let allStatsValid = true;
                    
                    const collectedStats = { teamA: [], teamB: [] };
                    // Não precisamos mais de ownGoalsByTeamA/B aqui, pois o placar é o que o usuário digita.

                    const processTeamStats = (teamKey, teamContainerId) => {
                        matchToFinalize[teamKey].players.forEach(pInMatch => {
                            const playerStats = { gols: 0, assistencias: 0, defesas: 0, golsSofridos: 0, golsContra: 0 };
                            document.querySelectorAll(`#${teamContainerId} input[data-player-id="${pInMatch.id}"]`).forEach(input => {
                                const statValue = parseInt(input.value);
                                if (isNaN(statValue) || statValue < 0) allStatsValid = false;
                                playerStats[input.dataset.stat] = statValue;
                            });
                            collectedStats[teamKey].push({ playerId: pInMatch.id, stats: playerStats, originalPosition: pInMatch.position });
                        });
                    };

                    processTeamStats('teamA', 'statsTeamAContainer');
                    processTeamStats('teamB', 'statsTeamBContainer');

                    if (!allStatsValid) {
                        statsErrorP.classList.remove('hidden');
                        return;
                    }
                    
                    const finalizedMatchData = scheduledMatches.splice(matchIndex, 1)[0]; 
                    finalizedMatchData.scoreA = finalScoreA; // Usa o placar digitado
                    finalizedMatchData.scoreB = finalScoreB; // Usa o placar digitado
                    finalizedMatchData.finalizedAt = new Date().toISOString();
                    
                    finalizedMatchData.teamA.players.forEach(p => p.matchStats = {});
                    finalizedMatchData.teamB.players.forEach(p => p.matchStats = {});

                    const resultTeamA = finalScoreA > finalScoreB ? 'win' : (finalScoreA < finalScoreB ? 'loss' : 'draw');
                    const resultTeamB = finalScoreB > finalScoreA ? 'win' : (finalScoreB < finalScoreA ? 'loss' : 'draw');

                    collectedStats.teamA.forEach(pStat => {
                        const playerGlobal = players.find(pl => pl.id === pStat.playerId);
                        if (playerGlobal) {
                            const overallChange = calculateOverallChange(playerGlobal, pStat.stats, resultTeamA);
                            playerGlobal.overall = Math.min(100, Math.max(50, Math.round(playerGlobal.overall + overallChange)));
                            const teamPlayer = finalizedMatchData.teamA.players.find(p => p.id === pStat.playerId);
                            if(teamPlayer) teamPlayer.matchStats = pStat.stats; 
                        }
                    });
                     collectedStats.teamB.forEach(pStat => {
                        const playerGlobal = players.find(pl => pl.id === pStat.playerId);
                        if (playerGlobal) {
                            const overallChange = calculateOverallChange(playerGlobal, pStat.stats, resultTeamB);
                            playerGlobal.overall = Math.min(100, Math.max(50, Math.round(playerGlobal.overall + overallChange)));
                            const teamPlayer = finalizedMatchData.teamB.players.find(p => p.id === pStat.playerId);
                            if(teamPlayer) teamPlayer.matchStats = pStat.stats;
                        }
                    });
                    
                    finishedMatches.push(finalizedMatchData);

                    savePlayersToLocalStorage();
                    saveScheduledMatchesToLocalStorage();
                    saveFinishedMatchesToLocalStorage();
                    renderPlayerList(); 
                    renderScheduledMatches();
                    renderFinishedMatches();
                    showMessageBox('Placar e estatísticas salvos! Overall atualizado.', 'success');
                    finalizingMatchId = null;
                    window.showPage(page1);
                }
            } catch (error) {
                console.error("Erro em saveScoreBtn:", error);
                showMessageBox(`Erro ao salvar placar: ${error.message}`, "error");
            }
        });


        // --- Inicialização ---
        document.getElementById('backToPlayersBtnPage2').addEventListener('click', () => window.showPage(page1));
        document.getElementById('backToDivisionBtnPage3').addEventListener('click', () => { editingMatchId = null; window.showPage(page2); }); 
        document.getElementById('backToColorsBtnPage4').addEventListener('click', () => {
            if (editingMatchId) { 
                const match = scheduledMatches.find(m => m.id === editingMatchId);
                if(match) prefillColorsForEdit(match);
            }
            window.showPage(page3);
        });
        
        loadPlayersFromLocalStorage(); 
        loadScheduledMatchesFromLocalStorage(); 
        loadFinishedMatchesFromLocalStorage(); 
        renderPlayerList(); 
        renderScheduledMatches(); 
        renderFinishedMatches(); 
        window.showPage(page1); 
    </script>
</body>
</html>
